#!/usr/bin/env bash

TPM_DIR="$HOME/.tmux/plugins/tpm"
CHANGED=""

enable_docker() {
  local docker_status
  docker_status="$(systemctl is-enabled docker.service)"
  if [[ "$docker_status" != "not-found" ]]; then
    if [[ "$docker_status" != "enabled" ]]; then
      # Add User to docker group
      sudo usermod -aG docker $USER
      sudo systemctl enable docker
      CHANGED="docker"
    fi
  fi
}

set_shell() {
  local default_shell
  default_shell="$(grep "^$(whoami):" /etc/passwd | cut -d: -f7)"
  if [ "$default_shell" != "/bin/zsh" ]; then
    sudo usermod --shell /bin/zsh "$USER" >/dev/null
    CHANGED="shell"
  fi
}

install_tpm() {
  mkdir -p ~/.tmux/plugins/ >/dev/null
  git clone https://github.com/tmux-plugins/tpm "$TPM_DIR" >/dev/null
  echo "Installing Tmux Plugins ..."
  "$TPM_DIR/scripts/install_plugins.sh" >/dev/null 2>&1
  CHANGED="tpm"
}

enable_mpd() {
  if [[ $(systemctl --user is-enabled mpd.service) != "enabled" ]]; then
    systemctl --user enable mpd.service
    systemctl --user enable mpd-mpris.service
  fi
}

enable_kanata() {
  if [[ $(systemctl --user is-enabled kanata.service) != "enabled" ]]; then
    # Enable User Services
    systemctl --user daemon-reload
    systemctl --user --now enable kanata.service
    CHANGED="kanata"
  fi
}

main() {
  # Remove temporary bin directory if it exists
  if [ -d "$HOME/bin" ]; then
    rm -rf "${HOME:?}/bin" >/dev/null 2>&1
  fi

  # Enabled kanata if  it is not
  enable_kanata

  # Enable Docker
  enable_docker

  # Enable Music Bits
  enable_mpd

  # Install Tmux Plugins
  if [ ! -d "$TPM_DIR" ]; then
    install_tpm
  fi

  if [ ! -d "$HOME/.config/yazi/plugins" ]; then
    echo "Installing yazi plugins ..."
    ya pkg install >/dev/null 2>&1
  fi

  # Export our ssh if bw is available and our key does not already exist
  if [[ ! -f "$HOME/.ssh/id_ed25519" ]]; then
    echo "Install SSH Private Key from Bitwarden"
  fi

  set_shell

  if [ ! -z "$CHANGED" ]; then
    echo "Installation complete ... restart recommended"
  fi
}

main "$@"
